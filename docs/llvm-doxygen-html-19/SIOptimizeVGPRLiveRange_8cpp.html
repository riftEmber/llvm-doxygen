<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LLVM: lib/Target/AMDGPU/SIOptimizeVGPRLiveRange.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">LLVM<span id="projectnumber">&#160;19.1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search',false);
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_794e483eb1cc7921d35fd149d9cc325b.html">Target</a></li><li class="navelem"><a class="el" href="dir_447ce995d6e35417de5ec3060e97c93e.html">AMDGPU</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">SIOptimizeVGPRLiveRange.cpp File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>This pass tries to remove unnecessary VGPR live ranges in divergent if-else structures and waterfall loops.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="AMDGPU_8h_source.html">AMDGPU.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="GCNSubtarget_8h_source.html">GCNSubtarget.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="AMDGPUMCTargetDesc_8h_source.html">MCTargetDesc/AMDGPUMCTargetDesc.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="SIMachineFunctionInfo_8h_source.html">SIMachineFunctionInfo.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="LiveVariables_8h_source.html">llvm/CodeGen/LiveVariables.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="MachineDominators_8h_source.html">llvm/CodeGen/MachineDominators.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="MachineLoopInfo_8h_source.html">llvm/CodeGen/MachineLoopInfo.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="TargetRegisterInfo_8h_source.html">llvm/CodeGen/TargetRegisterInfo.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="InitializePasses_8h_source.html">llvm/InitializePasses.h</a>&quot;</code><br />
</div>
<p><a href="SIOptimizeVGPRLiveRange_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ad78e062f62e0d6e453941fb4ca843e4d" id="r_ad78e062f62e0d6e453941fb4ca843e4d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG_TYPE</a>&#160;&#160;&#160;&quot;si-<a class="el" href="ARMLoadStoreOptimizer_8cpp.html#ab3bfc7321acfbc3619170d5bed907cb3">opt</a>-vgpr-liverange&quot;</td></tr>
<tr class="separator:ad78e062f62e0d6e453941fb4ca843e4d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ab6568ee2e44ad15f085148970ba380c2" id="r_ab6568ee2e44ad15f085148970ba380c2"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ab6568ee2e44ad15f085148970ba380c2">INITIALIZE_PASS_BEGIN</a> (SIOptimizeVGPRLiveRange, <a class="el" href="GenericCycleImpl_8h.html#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG_TYPE</a>, &quot;SI Optimize VGPR LiveRange&quot;, false, false) <a class="el" href="PassSupport_8h.html#a74ce8276b89067e806f67c45a6d92575">INITIALIZE_PASS_END</a>(SIOptimizeVGPRLiveRange</td></tr>
<tr class="separator:ab6568ee2e44ad15f085148970ba380c2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a030569d5a541b6110f2ae1b6a3413a58" id="r_a030569d5a541b6110f2ae1b6a3413a58"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a030569d5a541b6110f2ae1b6a3413a58">DEBUG_TYPE</a></td></tr>
<tr class="separator:a030569d5a541b6110f2ae1b6a3413a58"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acc192e3e53887e1d6fa56abbe10530e6" id="r_acc192e3e53887e1d6fa56abbe10530e6"><td class="memItemLeft" align="right" valign="top"><a class="el" href="PassBuilderBindings_8cpp.html#a10fde6bea2f819ef87db20d8fe3085c7">SI</a> Optimize VGPR&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#acc192e3e53887e1d6fa56abbe10530e6">LiveRange</a></td></tr>
<tr class="separator:acc192e3e53887e1d6fa56abbe10530e6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3f8ae3038974369df91a2df8bf131749" id="r_a3f8ae3038974369df91a2df8bf131749"><td class="memItemLeft" align="right" valign="top"><a class="el" href="PassBuilderBindings_8cpp.html#a10fde6bea2f819ef87db20d8fe3085c7">SI</a> Optimize VGPR&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a3f8ae3038974369df91a2df8bf131749">false</a></td></tr>
<tr class="separator:a3f8ae3038974369df91a2df8bf131749"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>This pass tries to remove unnecessary VGPR live ranges in divergent if-else structures and waterfall loops. </p>
<p>When we do structurization, we usually transform an if-else into two successive if-then (with a flow block to do predicate inversion). Consider a simple case after structurization: A divergent value a was defined before if-else and used in both THEN (use in THEN is optional) and ELSE part: bb.if: a = ... ... bb.then: ... = op a ... // a can be dead here bb.flow: ... bb.else: ... = a ... bb.endif</p>
<p>As register allocator has no idea of the thread-control-flow, it will just assume a would be alive in the whole range of bb.then because of a later use in bb.else. On AMDGPU architecture, the VGPR is accessed with respect to exec mask. For this if-else case, the lanes active in bb.then will be inactive in bb.else, and vice-versa. So we are safe to say that a was dead after the last use in bb.then until the end of the block. The reason is the instructions in bb.then will only overwrite lanes that will never be accessed in bb.else.</p>
<p>This pass aims to tell register allocator that a is in-fact dead, through inserting a phi-node in bb.flow saying that a is undef when coming from bb.then, and then replace the uses in the bb.else with the result of newly inserted phi.</p>
<p>Two key conditions must be met to ensure correctness: 1.) The def-point should be in the same loop-level as if-else-endif to make sure the second loop iteration still get correct data. 2.) There should be no further uses after the IF-ELSE region.</p>
<p>Waterfall loops get inserted around instructions that use divergent values but can only be executed with a uniform value. For example an indirect call to a divergent address: bb.start: a = ... fun = ... ... bb.loop: call fun (a) ... // a can be dead here loop bb.loop</p>
<p>The loop block is executed multiple times, but it is run exactly once for each active lane. Similar to the if-else case, the register allocator assumes that a is live throughout the loop as it is used again in the next iteration. If a is a VGPR that is unused after the loop, it does not need to be live after its last use in the loop block. By inserting a phi-node at the start of bb.loop that is undef when coming from bb.loop, the register allocation knows that the value of a does not need to be preserved through iterations of the loop. </p>

<p class="definition">Definition in file <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html">SIOptimizeVGPRLiveRange.cpp</a>.</p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="ad78e062f62e0d6e453941fb4ca843e4d" name="ad78e062f62e0d6e453941fb4ca843e4d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad78e062f62e0d6e453941fb4ca843e4d">&#9670;&#160;</a></span>DEBUG_TYPE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEBUG_TYPE&#160;&#160;&#160;&quot;si-<a class="el" href="ARMLoadStoreOptimizer_8cpp.html#ab3bfc7321acfbc3619170d5bed907cb3">opt</a>-vgpr-liverange&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html#l00086">86</a> of file <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html">SIOptimizeVGPRLiveRange.cpp</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="ab6568ee2e44ad15f085148970ba380c2" name="ab6568ee2e44ad15f085148970ba380c2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab6568ee2e44ad15f085148970ba380c2">&#9670;&#160;</a></span>INITIALIZE_PASS_BEGIN()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">INITIALIZE_PASS_BEGIN </td>
          <td>(</td>
          <td class="paramtype">SIOptimizeVGPRLiveRange</td>          <td class="paramname"><span class="paramname"><em></em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="GenericCycleImpl_8h.html#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG_TYPE</a></td>          <td class="paramname"><span class="paramname"><em></em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;SI Optimize VGPR LiveRange&quot;</td>          <td class="paramname"><span class="paramname"><em></em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">false</td>          <td class="paramname"><span class="paramname"><em></em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">false</td>          <td class="paramname"><span class="paramname"><em></em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a030569d5a541b6110f2ae1b6a3413a58" name="a030569d5a541b6110f2ae1b6a3413a58"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a030569d5a541b6110f2ae1b6a3413a58">&#9670;&#160;</a></span>DEBUG_TYPE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">DEBUG_TYPE</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html#l00624">624</a> of file <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html">SIOptimizeVGPRLiveRange.cpp</a>.</p>

</div>
</div>
<a id="a3f8ae3038974369df91a2df8bf131749" name="a3f8ae3038974369df91a2df8bf131749"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3f8ae3038974369df91a2df8bf131749">&#9670;&#160;</a></span>false</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="PassBuilderBindings_8cpp.html#a10fde6bea2f819ef87db20d8fe3085c7">SI</a> Optimize VGPR false</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html#l00625">625</a> of file <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html">SIOptimizeVGPRLiveRange.cpp</a>.</p>

</div>
</div>
<a id="acc192e3e53887e1d6fa56abbe10530e6" name="acc192e3e53887e1d6fa56abbe10530e6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acc192e3e53887e1d6fa56abbe10530e6">&#9670;&#160;</a></span>LiveRange</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="PassBuilderBindings_8cpp.html#a10fde6bea2f819ef87db20d8fe3085c7">SI</a> Optimize VGPR <a class="el" href="classllvm_1_1LiveRange.html">LiveRange</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html#l00625">625</a> of file <a class="el" href="SIOptimizeVGPRLiveRange_8cpp_source.html">SIOptimizeVGPRLiveRange.cpp</a>.</p>

<p class="reference">Referenced by <a class="el" href="StackLifetime_8h_source.html#l00162">llvm::StackLifetime::getFullLiveRange()</a>, <a class="el" href="LiveIntervals_8h_source.html#l00404">llvm::LiveIntervals::getRegUnit()</a>, and <a class="el" href="StackLifetime_8cpp_source.html#l00330">llvm::StackLifetime::run()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Nov 1 2024 13:46:53 for LLVM by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
